#+TITLE: Ivche's Config
#+STARTUP: overview
#+RESULTS: nil

* Personal Info

#+BEGIN_SRC emacs-lisp
(setq user-full-name "Ivche"
      user-mail-address "ivche@trajkov.mk")
#+END_SRC

* Settings
** Custom Keybinds
*** erc
#+begin_src emacs-lisp
(map! :leader
      :desc "Start ERC"
      "o i" #'znc-all
      "i i" #'erc-switch-to-buffer)

;;(map! :map specific-mode-map :n "J" (cmd! (a-function) (b-function)))
(map! :map erc-mode-map :n "J" #'erc-join-channel)
(map! :map erc-mode-map :n "qq" #'my/erc-stop)
#+end_src

*** dired
#+begin_src emacs-lisp
(defun my/dired-nas () (interactive) (dired "/mnt/nas"))
(defun my/dired-notes () (interactive) (dired "/mnt/nas/documents/org/personal"))

(map! :map global-map
      :leader
      :n "j n n" #'my/dired-nas)

(map! :map global-map
      :leader
      :n "j n p" #'my/dired-notes)

#+end_src

*** evil
#+begin_src emacs-lisp
(defun my/org-retrieve-url-from-point ()
  "Copies the URL from an org link at the point"
  (interactive)
  (let ((plain-url (url-get-url-at-point)))
    (if plain-url
        (progn
          (kill-new plain-url)
          (message (concat "Copied: " plain-url)))
      (let* ((link-info (assoc :link (org-context)))
             (text (when link-info
                     (buffer-substring-no-properties
                      (or (cadr link-info) (point-min))
                      (or (caddr link-info) (point-max))))))
        (if (not text)
            (error "Oops! Point isn't in an org link")
          (string-match org-link-bracket-re text)
          (let ((url (substring text (match-beginning 1) (match-end 1))))
            (kill-new url)
            (message (concat "Copied: " url))))))))

(map! :map global-map
      :leader
      :n "l y" #'my/org-retrieve-url-from-point )

#+end_src

** Authinfo
#+begin_src emacs-lisp
(setq auth-sources '("~/.authinfo.gpg"))
#+end_src
** Scratch Buffer Message
#+begin_src emacs-lisp
(setq initial-scratch-message ";; Happy Hacking!\n")
#+end_src
** Font
#+BEGIN_SRC emacs-lisp
(setq doom-font (font-spec :family "SourceCodeVF" :size 18))
#+END_SRC
** Lines
#+BEGIN_SRC emacs-lisp
(setq display-line-numbers-type 'relative)
(setq truncate-lines nil)
(setq scroll-margin 9)
#+END_SRC
** Theme
#+BEGIN_SRC emacs-lisp
(setq doom-theme 'catppuccin)
(setq catppuccin-flavor 'mocha)
(setq doom-modeline-height 4)
;; (set-frame-parameter (selected-frame) 'alpha '(97 . 97))
;; (add-to-list 'default-frame-alist '(alpha . (97 . 97)))
#+end_src

* Packages
** mu4e
#+begin_src emacs-lisp
(require 'mu4e)
(require 'mu4e-contrib)
(require 'smtpmail)

(set-email-account! "icloud"
  '((user-mail-address . "trajkov.ivan@icloud.com")
    (user-full-name    . "Ivan Trajkov")
    (smtpmail-smtp-server . "smtp.mail.me.com")
    (smtpmail-smtp-service . 587)
    (smtpmail-stream-type . ssl)
    (smtpmail-smtp-user . "trajkov.ivan@icloud.com")
    (mu4e-drafts-folder  . "/icloud/Drafts")
    (mu4e-sent-folder  . "/icloud/Sent Mail")
    (mu4e-refile-folder  . "/icloud/All Mail")
    (mu4e-trash-folder  . "/icloud/Trash")
    (smtpmail-queue-dir .  "~/Mail/icloud/queue/cur")
    (mu4e-compose-signature . "---\nYours truly\nIvan.")
    (mu4e-maildir-shortcuts .
        (("/icloud/Inbox"             . ?i)
        ("/icloud/Sent Mail" . ?s)
        ("/icloud/Trash"     . ?t)
        ("/icloud/Drafts"    . ?d)
        ("/icloud/All Mail"  . ?a))))
  t)

(setq smtpmail-queue-mail t)  ;; start in queuing mode

(setq message-send-mail-function 'message-send-mail-with-sendmail)
(setq sendmail-program "/usr/bin/msmtp")
(setq message-sendmail-extra-arguments '("--read-envelope-from"))
(setq message-sendmail-f-is-evil 't)

(after! mu4e
  (setq mu4e-update-interval 60
        mu4e-get-mail-command "mbsync -a"
        mu4e-headers-auto-update t))

(setq mu4e-context-policy 'pick-first
      mu4e-compose-context-policy 'always-ask)

(setq mu4e-index-cleanup nil
      mu4e-index-lazy-check t)

(setq mu4e-alert-icon "/usr/share/icons/Papirus-Dark/16x16/mimetypes/mail.svg")

(setq mu4e-headers-fields
      '((:flags . 6)
        (:account-stripe . 2)
        (:from-or-to . 25)
        (:recipnum . 2)
        (:subject . 80)
        (:human-date . 8))
      +mu4e-min-header-frame-width 142
      mu4e-headers-date-format "%d/%m/%y"
      mu4e-headers-time-format "â§– %H:%M"
      mu4e-headers-results-limit 1000
      mu4e-index-cleanup t)
#+end_src

** company
#+BEGIN_SRC emacs-lisp
(after! company
    (setq default-tab-width 4)
    (setq company-minimum-prefix-length 1)
    (setq company-idle-delay 0))
#+END_SRC

** elcord
#+begin_src emacs-lisp
(use-package! elcord
  :commands elcord-mode
  :config
  (setq elcord-use-major-mode-as-main-icon t))

(elcord-mode)
#+end_src

** leetcode
#+begin_src src
(after! leetcode
    (setq leetcode-prefer-language "cpp")
    (setq leetcode-save-solutions t)
    (setq leetcode-directory "~/dev/leetcode"))
#+end_src

** org-caldav
#+begin_src emacs-lisp
(require 'org-caldav)

;; URL of the caldav server
(setq org-caldav-url "https://nextcloud.trajkov.mk/remote.php/dav/calendars/ivche")

;; calendar ID on server
(setq org-caldav-calendar-id "personal")

;; Org filename where new entries from calendar stored
(setq org-caldav-inbox (concat org-directory "/calendars/personal.org"))

;; Additional Org files to check for calendar events
(setq org-caldav-files nil)

;; Usually a good idea to set the timezone manually
(setq org-icalendar-timezone "Europe/Skopje")
#+end_src

** lsp
#+begin_src emacs-lisp
(setq lsp-headerline-breadcrumb-enable t)
#+end_src

** erc
#+begin_src emacs-lisp
(require 'erc-log)
(require 'erc-notify)
(require 'erc-spelling)
(require 'erc-autoaway)

(use-package erc
  :config
    (add-hook 'window-configuration-change-hook
        '(lambda ()
            (setq erc-fill-column (- (window-width) 2))))

    ;; Interpret mIRC-style color commands in IRC chats
    (setq erc-interpret-mirc-color t)

    ;; Kill buffers for channels after /part
    (setq erc-kill-buffer-on-part t)

    ;; Kill buffers for private queries after quitting the server
    (setq erc-kill-queries-on-quit t)

    ;; Kill buffers for server messages after quitting the server
    (setq erc-kill-server-buffer-on-quit t)

    ;; open query buffers in the current window
    (setq erc-query-display 'buffer)

    (setq erc-track-shorten-function nil)
    ;; exclude boring stuff from tracking
    (erc-track-mode t)
    (setq erc-track-exclude-types '("JOIN" "NICK" "PART" "QUIT" "MODE"
                                    "324" "329" "332" "333" "353" "477"))

    ;; truncate long irc buffers
    (erc-truncate-mode +1)

    ;; enable spell checking
    (erc-spelling-mode 1)

    (defvar erc-notify-timeout 10
    "Number of seconds that must elapse between notifications from
    the same person.")

    (defun my/erc-notify (nickname message)
    "Displays a notification message for ERC."
    (let* ((channel (buffer-name))
            (nick (erc-hl-nicks-trim-irc-nick nickname))
            (title (if (string-match-p (concat "^" nickname) channel)
                        nick
                    (concat nick " (" channel ")")))
            (msg (s-trim (s-collapse-whitespace message))))
        (alert (concat nick ": " msg) :title title)))

    ;; autoaway setup
    (setq erc-auto-discard-away t)
    (setq erc-autoaway-idle-seconds 600)
    (setq erc-autoaway-use-emacs-idle t)

    ;; utf-8 always and forever
    (setq erc-server-coding-system '(utf-8 . utf-8))

    (defun my/erc-stop ()
    "Disconnects from all irc servers"
    (interactive)
    (dolist (buffer (filter-server-buffers))
        (message "Server buffer: %s" (buffer-name buffer))
        (with-current-buffer buffer
        (erc-quit-server "cya nerds! - sent from ERC"))))
)

(use-package erc-hl-nicks
  :after erc)
#+end_src

** znc
#+begin_src emacs-lisp
(require 'znc)
(setq znc-password (password-store-get "znc"))
(setq znc-servers
    `(("znc.trajkov.mk" 27444 t
      ((mam "ivche/mam" ,znc-password)
       (libera "ivche/libera" ,znc-password))
)))
#+end_src

** smudge
#+begin_src emacs-lisp
(setq smudge-oauth2-client-secret (password-store-get "smudge-secret"))
(setq smudge-oauth2-client-id (password-store-get "smudge-id"))
(setq smudge-transport 'connect)
(map! :prefix "C-s"
        :desc "Toggle Play/Pause" "p" #'smudge-controller-toggle-play
        :desc "Next Track" "n" #'smudge-controller-next-track
        :desc "Previous Track" "b" #'smudge-controller-previous-track
        :desc "Playlists" "P" #'smudge-my-playlists
        :desc "Track Search" "s" #'smudge-track-search)
#+end_src

* Languages
** Python
#+begin_src emacs-lisp
(add-hook 'python-mode-hook
        (lambda ()
        (setq lsp-pylsp-plugins-mccabe-enabled nil)
        (setq lsp-pylsp-plugins-flake8-enabled nil)
        (setq lsp-pylsp-plugins-pyflakes-enabled nil)
        (setq lsp-pylsp-plugins-pydocstyle-enabled nil)
        (setq lsp-pylsp-plugins-mypy-enabled t)
        (setq lsp-pylsp-plugins-mypy-dmypy t)
        (setq lsp-pylsp-plugins-mypy-strict t)
        (setq lsp-pylsp-plugins-ruff-enabled t)
        ))


;; (after! dap
;;   (setq dap-python-debugger 'debugpy))
#+end_src

* Org Mode
** General
#+begin_src emacs-lisp
(setq org-directory "~/Documents/org")
(setq org-log-done 'time)
#+end_src

** Visuals
#+begin_src emacs-lisp
(add-hook 'org-mode-hook #'+org-pretty-mode)

(custom-set-faces!
  '(outline-1 :weight extra-bold :height 1.25)
  '(outline-2 :weight bold :height 1.15)
  '(outline-3 :weight bold :height 1.12)
  '(outline-4 :weight semi-bold :height 1.09)
  '(outline-5 :weight semi-bold :height 1.06)
  '(outline-6 :weight semi-bold :height 1.03)
  '(outline-8 :weight semi-bold)
  '(outline-9 :weight semi-bold))

(custom-set-faces!
  '(org-document-title :height 1.2))

(setq org-agenda-deadline-faces
      '((1.001 . error)
        (1.0 . org-warning)
        (0.5 . org-upcoming-deadline)
        (0.0 . org-upcoming-distant-deadline)))

(setq org-fontify-quote-and-verse-blocks t)
#+end_src

** elfeed
#+begin_src emacs-lisp
(setq rmh-elfeed-org-files (list (concat org-directory "/elfeed.org")))
#+end_src

** org-capture
#+begin_src emacs-lisp
(setq org-capture-templates `(
    ("p" "Protocol" entry (file+headline ,(concat org-directory "/inbox.org") "Captured Quotes")
     "* %^{Title}\nSource: %u, %c\n #+BEGIN_QUOTE\n%i\n#+END_QUOTE\n\n\n%?")
    ("i" "Inbox" entry (file ,(concat org-directory "/inbox.org"))
     "* %? \nCaptured on: %T")
))
#+end_src

** org-roam
#+begin_src emacs-lisp
(require 'org-roam)
(setq org-roam-directory (concat org-directory "/roam"))

(setq org-roam-capture-templates
      '(("l" "literature" plain "%?"
         :if-new (file+head "literature/${slug}.org" "#+title: ${title}\n")
         :immediate-finish t
         :unnarrowed t)
        ("p" "permanent" plain "%?"
         :if-new (file+head "permanent/${title}.org" "#+title: ${title}\n")
         :immediate-finish t
         :unnarrowed t)
        ("a" "article" plain "%?"
         :if-new (file+head "article/${title}.org" "#+title: ${title}\n#+filetags: :article:\n")
         :immediate-finish t
         :unnarrowed t)))

(cl-defmethod org-roam-node-type ((node org-roam-node))
  "Return the TYPE of NODE."
  (condition-case nil
      (file-name-nondirectory
       (directory-file-name
        (file-name-directory
         (file-relative-name (org-roam-node-file node) org-roam-directory))))
    (error "")))

(setq org-roam-node-display-template
      (concat "${type:15} ${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
#+end_src

** org-agenda
#+begin_src emacs-lisp
(setq org-agenda-files (list (concat org-directory "/calendars/personal.org")))
#+end_src

** org-pomodoro
#+begin_src emacs-lisp
(after! org-pomodoro
        (setq org-pomodoro-length 50)
        (setq org-pomodoro-short-break-length 10)
        (setq org-pomodoro-long-break-length 30)
        (setq org-pomodoro-long-break-frequency 4)
        (setq org-pomodoro-short-break-sound "~/.config/doom/org-pomodoro-break.wav")
        (setq org-pomodoro-long-break-sound "~/.config/doom/org-pomodoro-break.wav")
        (setq org-pomodoro-finished-sound "~/.config/doom/org-pomodoro-finished.wav")
)
#+end_src
